# üìß Gu√≠a Completa: Configuraci√≥n de Email/SMTP

## üéØ Resumen

El sistema ahora lee la configuraci√≥n SMTP **directamente desde la base de datos** (colecci√≥n `settings`) en lugar de usar variables de entorno. Esto significa que puedes configurar el email desde la interfaz web sin necesidad de acceder al servidor.

---

## ‚úÖ Ventajas del Nuevo Sistema

1. **‚ú® Configuraci√≥n desde la interfaz**: No necesitas editar archivos .env
2. **üîí Usa el email de la empresa**: Los emails se env√≠an desde la cuenta configurada en Settings
3. **üß™ Prueba en vivo**: Bot√≥n para probar la conexi√≥n SMTP antes de guardar
4. **üîÑ Cambios instant√°neos**: Sin necesidad de reiniciar el servidor
5. **üì± Multi-proveedor**: Soporta Gmail, Outlook, Yahoo, etc.

---

## üöÄ Paso 1: Configurar Gmail para Env√≠o de Emails

### Opci√≥n A: Contrase√±a de Aplicaci√≥n (Recomendado)

1. **Ir a tu cuenta de Gmail**
   - URL: https://myaccount.google.com

2. **Activar verificaci√≥n en 2 pasos**
   - Seguridad ‚Üí Verificaci√≥n en 2 pasos ‚Üí Activar

3. **Generar contrase√±a de aplicaci√≥n**
   - Seguridad ‚Üí Contrase√±as de aplicaciones
   - Seleccionar: Correo ‚Üí Windows Computer
   - Copiar la contrase√±a de 16 d√≠gitos (ejemplo: `abcd efgh ijkl mnop`)

### Opci√≥n B: Permitir Aplicaciones Menos Seguras (No recomendado)

1. Ir a: https://myaccount.google.com/lesssecureapps
2. Activar "Permitir aplicaciones menos seguras"
3. Usar tu contrase√±a normal de Gmail

---

## üîß Paso 2: Configurar en la Interfaz Web

### 2.1 Acceder a Configuraci√≥n

1. Iniciar sesi√≥n como **administrador**
2. Ir a: **Configuraci√≥n** (sidebar) o presionar `Ctrl + ,`
3. Buscar la secci√≥n: **üìß Configuraci√≥n de Email/SMTP**

### 2.2 Completar los Campos

#### Para Gmail:
```
Proveedor SMTP:     smtp.gmail.com
Puerto:             587
Usar SSL:           No (desactivado)
Usuario (Email):    tucorreo@gmail.com
Contrase√±a:         abcd efgh ijkl mnop (contrase√±a de app)
Nombre Remitente:   Nombre de tu Empresa
Email Remitente:    tucorreo@gmail.com
```

#### Para Outlook/Hotmail:
```
Proveedor SMTP:     smtp.office365.com
Puerto:             587
Usar SSL:           No
Usuario:            tucorreo@hotmail.com
Contrase√±a:         tu_contrase√±a
```

#### Para Yahoo:
```
Proveedor SMTP:     smtp.mail.yahoo.com
Puerto:             587
Usar SSL:           No
Usuario:            tucorreo@yahoo.com
Contrase√±a:         contrase√±a_de_app
```

### 2.3 Probar Conexi√≥n

1. Hacer clic en **"üß™ Probar Conexi√≥n"**
2. Esperar el resultado:
   - ‚úÖ **√âxito**: Configuraci√≥n v√°lida, puedes guardar
   - ‚ùå **Error**: Revisar credenciales o configuraci√≥n

### 2.4 Guardar Configuraci√≥n

1. Hacer clic en **"üíæ Guardar Configuraci√≥n SMTP"**
2. Ver√°s un mensaje de confirmaci√≥n
3. La configuraci√≥n se guarda en la base de datos MongoDB

---

## üì§ Paso 3: Enviar √ìrdenes de Compra por Email

Una vez configurado el SMTP:

1. **Ir a √ìrdenes de Compra**
2. **Crear una orden nueva** o seleccionar una existente
3. **Hacer clic en "üìß Enviar por Email"** (bot√≥n en la interfaz)
4. El sistema:
   - Lee la configuraci√≥n SMTP de la BD
   - Verifica que el proveedor tenga email
   - Env√≠a el email con plantilla HTML profesional
   - Marca la orden como "Email Enviado"

### Email que se env√≠a:

- ‚úÖ Header con logo y nombre de la empresa
- ‚úÖ Datos del negocio (RNC, tel√©fono, email)
- ‚úÖ Informaci√≥n del proveedor
- ‚úÖ Tabla de productos con precios
- ‚úÖ Total de la orden
- ‚úÖ Notas adicionales
- ‚úÖ Footer profesional

---

## üîç Paso 4: Verificar en Railway (Opcional)

Ya **NO necesitas** configurar variables SMTP en Railway porque el sistema lee de la base de datos. Sin embargo, puedes verificar:

1. **Ir a Railway Dashboard**: https://railway.app
2. **Seleccionar tu proyecto**
3. **Ir a Variables**
4. **Eliminar variables antiguas** (si las ten√≠as):
   - ~~SMTP_HOST~~
   - ~~SMTP_PORT~~
   - ~~SMTP_USER~~
   - ~~SMTP_PASS~~

El sistema ya **NO usa** esas variables. Todo viene de MongoDB.

---

## üõ†Ô∏è Arquitectura T√©cnica

### Flujo de Env√≠o de Email:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Frontend (React)   ‚îÇ
‚îÇ  Bot√≥n "Enviar"     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ POST /api/purchase-orders/:id/send
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Controller         ‚îÇ
‚îÇ  sendPurchaseOrder  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Prepara datos
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Email Service      ‚îÇ
‚îÇ  emailService.js    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ 1. Lee Settings de MongoDB
           ‚îÇ 2. Crea transporter con SMTP
           ‚îÇ 3. Genera HTML del email
           ‚îÇ 4. Env√≠a con nodemailer
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  MongoDB (Settings) ‚îÇ
‚îÇ  smtp: { host, ... }‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Configuraci√≥n din√°mica
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Servidor SMTP      ‚îÇ
‚îÇ  (Gmail, Outlook)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Modelos Actualizados:

**Settings.js**:
```javascript
{
  businessName: "Mi Taller",
  businessEmail: "contacto@mitaller.com",
  smtp: {
    host: "smtp.gmail.com",
    port: 587,
    secure: false,
    user: "contacto@mitaller.com",
    password: "abcd efgh ijkl mnop", // select: false (no se retorna)
    fromName: "Mi Taller Mec√°nico",
    fromEmail: "contacto@mitaller.com"
  }
}
```

---

## üêõ Troubleshooting

### Error: "Configuraci√≥n SMTP no encontrada"

**Causa**: No has configurado el SMTP todav√≠a.

**Soluci√≥n**:
1. Ir a Configuraci√≥n
2. Secci√≥n Email/SMTP
3. Completar todos los campos
4. Guardar

---

### Error: "Invalid login"

**Causa**: Credenciales incorrectas o no usas contrase√±a de aplicaci√≥n.

**Soluci√≥n**:
1. Verificar email y contrase√±a
2. Si usas Gmail, **DEBES** usar contrase√±a de aplicaci√≥n
3. Verificar que la verificaci√≥n en 2 pasos est√© activa
4. Regenerar contrase√±a de aplicaci√≥n

---

### Error: "Connection timeout"

**Causa**: Puerto o host incorrectos.

**Soluci√≥n**:
- Gmail: `smtp.gmail.com:587` (SSL: No)
- Outlook: `smtp.office365.com:587` (SSL: No)
- Para puerto 465, activar SSL: S√≠

---

### Error: "El proveedor no tiene email"

**Causa**: El proveedor seleccionado no tiene email configurado.

**Soluci√≥n**:
1. Ir a Proveedores
2. Editar el proveedor
3. Agregar email v√°lido
4. Guardar

---

### Email no llega al proveedor

**Pasos de diagn√≥stico**:

1. **Verificar en spam/correo no deseado**
   - El email puede estar en spam del proveedor

2. **Revisar logs del servidor**
   ```bash
   railway logs
   ```
   - Buscar errores de "sendPurchaseOrderEmail"

3. **Probar conexi√≥n SMTP**
   - Bot√≥n "Probar Conexi√≥n" en Configuraci√≥n
   - Debe decir "‚úÖ Conexi√≥n exitosa"

4. **Verificar email del proveedor**
   - Asegurarse que el email sea v√°lido
   - Probar enviando a tu propio email primero

---

## üìä Estados de Email en √ìrdenes

Cada orden de compra tiene campos de tracking:

```javascript
{
  orderNumber: "PO-000001",
  emailSent: true,              // ¬øSe envi√≥ el email?
  emailSentDate: "2025-01-15",  // ¬øCu√°ndo se envi√≥?
  // ...
}
```

En la interfaz ver√°s:
- üìß **Enviado**: Email enviado exitosamente
- üì≠ **No enviado**: A√∫n no se ha enviado

---

## üé® Personalizaci√≥n del Email

El email usa autom√°ticamente:
- **Nombre del negocio**: `settings.businessName`
- **Logo**: `settings.businessLogoUrl`
- **RNC**: `settings.rnc` (si est√° configurado)
- **Tel√©fono**: `settings.businessPhone`
- **Email**: `settings.businessEmail`
- **Nombre del remitente**: `settings.smtp.fromName`

Todos estos se configuran en: **Configuraci√≥n > Negocio**

---

## üîê Seguridad

### Contrase√±a SMTP:
- ‚úÖ Campo `select: false` en Mongoose (no se retorna en queries)
- ‚úÖ Se oculta en respuestas GET de /api/settings
- ‚úÖ Solo se actualiza si se proporciona (no se borra por accidente)
- ‚úÖ No se muestra en frontend
- ‚úÖ Solo admin puede actualizar

### Buenas Pr√°cticas:
1. Usar **contrase√±as de aplicaci√≥n**, no contrase√±as de cuenta
2. Activar **verificaci√≥n en 2 pasos**
3. No compartir credenciales SMTP
4. Rotar contrase√±as peri√≥dicamente
5. Monitorear logs de env√≠o

---

## üìù API Endpoints

### 1. Obtener Configuraci√≥n
```http
GET /api/settings
Authorization: Bearer <token>

Response:
{
  businessName: "Mi Taller",
  smtp: {
    host: "smtp.gmail.com",
    port: 587,
    user: "contacto@mitaller.com",
    password: "", // Oculto
    // ...
  }
}
```

### 2. Actualizar SMTP
```http
PUT /api/settings/smtp
Authorization: Bearer <token>
Content-Type: application/json

{
  "host": "smtp.gmail.com",
  "port": 587,
  "secure": false,
  "user": "contacto@mitaller.com",
  "password": "abcd efgh ijkl mnop",
  "fromName": "Mi Taller",
  "fromEmail": "contacto@mitaller.com"
}

Response:
{
  "success": true,
  "message": "Configuraci√≥n SMTP actualizada correctamente",
  "data": { ... }
}
```

### 3. Probar Conexi√≥n SMTP
```http
POST /api/settings/smtp/test
Authorization: Bearer <token>

Response:
{
  "success": true,
  "message": "‚úÖ Configuraci√≥n SMTP v√°lida. Conexi√≥n exitosa."
}
```

### 4. Enviar Orden por Email
```http
POST /api/purchase-orders/:id/send
Authorization: Bearer <token>

Response:
{
  "message": "Orden enviada exitosamente a proveedor@email.com",
  "order": { ... }
}
```

---

## ‚úÖ Checklist de Configuraci√≥n

- [ ] Crear contrase√±a de aplicaci√≥n en Gmail
- [ ] Iniciar sesi√≥n como admin en la app
- [ ] Ir a Configuraci√≥n
- [ ] Completar datos del negocio (nombre, email, tel√©fono)
- [ ] Completar secci√≥n SMTP:
  - [ ] Host (smtp.gmail.com)
  - [ ] Puerto (587)
  - [ ] Usuario (email)
  - [ ] Contrase√±a (contrase√±a de app)
  - [ ] Nombre remitente
- [ ] Hacer clic en "Probar Conexi√≥n"
- [ ] Verificar mensaje de √©xito ‚úÖ
- [ ] Guardar configuraci√≥n
- [ ] Verificar que proveedores tengan email
- [ ] Crear orden de compra de prueba
- [ ] Enviar email de prueba
- [ ] Verificar que llegue al proveedor

---

## üéì Preguntas Frecuentes

### ¬øPuedo usar mi email personal?
S√≠, pero es recomendable usar un email profesional del negocio para dar mejor imagen.

### ¬øCu√°nto cuesta enviar emails?
Gmail permite **500 emails por d√≠a gratis**. Para m√°s, necesitas Google Workspace ($6/mes).

### ¬øPuedo usar otro proveedor que no sea Gmail?
S√≠, el sistema soporta cualquier servidor SMTP. Solo cambia el host y puerto.

### ¬øLos emails se guardan?
No, los emails se env√≠an directamente al proveedor. No se almacenan en la base de datos.

### ¬øPuedo enviar emails a m√∫ltiples proveedores a la vez?
Actualmente no, pero se puede agregar esta funcionalidad en el futuro.

### ¬øQu√© pasa si cambio la configuraci√≥n SMTP?
Los cambios se aplican inmediatamente. Los emails futuros usar√°n la nueva configuraci√≥n.

---

## üöÄ Pr√≥ximas Mejoras

Ideas para futuras versiones:
- [ ] Email con adjunto PDF de la orden
- [ ] Templates personalizables de email
- [ ] Env√≠o masivo de √≥rdenes
- [ ] Historial de emails enviados
- [ ] Reenv√≠o autom√°tico si falla
- [ ] Emails a clientes (facturas, recibos)
- [ ] Notificaciones por email (stock bajo, etc.)

---

## üìö Recursos Adicionales

- **Nodemailer**: https://nodemailer.com/
- **Gmail App Passwords**: https://support.google.com/accounts/answer/185833
- **SMTP Codes**: https://www.mailersend.com/blog/smtp-codes

---

**Fecha**: Octubre 2025  
**Versi√≥n**: 2.1.0  
**Autor**: Sistema AutoParts Manager
