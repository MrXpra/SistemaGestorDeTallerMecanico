import readline from 'readline';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { generateSecureJWT } from './generateJWT.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Crear interfaz de readline
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

// Funci├│n para hacer preguntas
function question(prompt) {
  return new Promise((resolve) => {
    rl.question(prompt, resolve);
  });
}

// Funci├│n para mostrar el banner
function showBanner() {
  console.log('\nÔòöÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòù');
  console.log('Ôòæ                                                           Ôòæ');
  console.log('Ôòæ       ­ƒÜù AutoParts Manager - Configuraci├│n Inicial       Ôòæ');
  console.log('Ôòæ                                                           Ôòæ');
  console.log('ÔòÜÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòØ\n');
  console.log('Este asistente te ayudar├í a configurar las variables de entorno\n');
}

// Funci├│n principal de setup
async function setup() {
  try {
    showBanner();

    // Verificar si ya existe un archivo .env
    const envPath = path.join(__dirname, '..', '.env');
    if (fs.existsSync(envPath)) {
      console.log('ÔÜá´©Å  Ya existe un archivo .env en el proyecto.\n');
      const overwrite = await question('┬┐Deseas sobrescribirlo? (s/n): ');
      if (overwrite.toLowerCase() !== 's') {
        console.log('\nÔ£à Configuraci├│n cancelada. Se mantendr├í el archivo .env actual.\n');
        rl.close();
        return;
      }
      console.log('');
    }

    console.log('­ƒôØ Por favor, proporciona la siguiente informaci├│n:\n');
    console.log('ÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉ\n');

    // 1. MongoDB URI
    console.log('1´©ÅÔâú  MONGODB_URI');
    console.log('   Cadena de conexi├│n a tu base de datos MongoDB');
    console.log('   Ejemplos:');
    console.log('   ÔÇó Local: mongodb://localhost:27017/autoparts');
    console.log('   ÔÇó Atlas: mongodb+srv://usuario:pass@cluster.mongodb.net/database\n');
    
    const mongoUri = await question('   Ingresa tu MONGODB_URI: ');
    console.log('');

    // 2. JWT Secret
    console.log('2´©ÅÔâú  JWT_SECRET');
    console.log('   Clave secreta para firmar tokens de autenticaci├│n');
    console.log('   Debe ser una cadena larga y segura (m├¡nimo 32 caracteres)\n');
    
    const generateJwt = await question('   ┬┐Deseas generar un JWT_SECRET autom├íticamente? (s/n): ');
    let jwtSecret;
    
    if (generateJwt.toLowerCase() === 's') {
      jwtSecret = generateSecureJWT();
      console.log('   Ô£à JWT_SECRET generado autom├íticamente\n');
    } else {
      jwtSecret = await question('   Ingresa tu JWT_SECRET personalizado: ');
      console.log('');
    }

    // 3. Puerto
    console.log('3´©ÅÔâú  PORT');
    console.log('   Puerto en el que se ejecutar├í el servidor backend\n');
    
    const portInput = await question('   Puerto del servidor (presiona Enter para usar 5000): ');
    const port = portInput.trim() || '5000';
    console.log('');

    // 4. NODE_ENV
    console.log('4´©ÅÔâú  NODE_ENV');
    console.log('   Entorno de ejecuci├│n: development o production\n');
    
    const nodeEnvInput = await question('   NODE_ENV (presiona Enter para "development"): ');
    const nodeEnv = nodeEnvInput.trim() || 'development';
    console.log('');

    // Funci├│n para escapar comillas simples dentro de los valores
    function escapeSingleQuotes(value) {
      return String(value).replace(/'/g, "\\'");
    }

    // Crear contenido del archivo .env (valores entre comillas simples obligatorias)
    const envContent = `# Configuraci├│n de AutoParts Manager
# Generado autom├íticamente el ${new Date().toLocaleString('es-MX')}

# Conexi├│n a MongoDB
MONGODB_URI='${escapeSingleQuotes(mongoUri)}'

# Secreto para JWT (┬íNUNCA COMPARTAS ESTE VALOR!)
JWT_SECRET='${escapeSingleQuotes(jwtSecret)}'

# Puerto del servidor
PORT='${escapeSingleQuotes(port)}'

# Entorno de ejecuci├│n
NODE_ENV='${escapeSingleQuotes(nodeEnv)}'
`;

    // Guardar archivo .env
    fs.writeFileSync(envPath, envContent, 'utf8');

    console.log('ÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉ\n');
    console.log('Ô£à Archivo .env creado exitosamente en la ra├¡z del proyecto\n');
    console.log('­ƒôï Resumen de configuraci├│n:');
    console.log(`   ÔÇó Base de datos: ${mongoUri.substring(0, 30)}...`);
    console.log(`   ÔÇó JWT Secret: ${jwtSecret.substring(0, 16)}... (${jwtSecret.length} caracteres)`);
    console.log(`   ÔÇó Puerto: ${port}`);
    console.log(`   ÔÇó Entorno: ${nodeEnv}\n`);
    console.log('ÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉ\n');
    console.log('­ƒÜÇ Pr├│ximos pasos:');
    console.log('   1. Verifica tu archivo .env en la ra├¡z del proyecto');
    console.log('   2. Ejecuta "npm run seed" para poblar la base de datos');
    console.log('   3. Ejecuta "npm run dev" para iniciar el servidor\n');
    console.log('ÔÜá´©Å  IMPORTANTE: Nunca subas el archivo .env a GitHub\n');

    rl.close();
  } catch (error) {
    console.error('\nÔØî Error durante la configuraci├│n:', error.message);
    rl.close();
    process.exit(1);
  }
}

// Ejecutar setup
setup();
